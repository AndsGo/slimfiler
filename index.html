<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ImageProcess Demo - Goå›¾åƒå¤„ç†åº“æ¼”ç¤º</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .upload-section {
            grid-column: 1 / -1;
            text-align: center;
            margin-bottom: 20px;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            background: #f8f9ff;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: #eef2ff;
        }

        .upload-area i {
            font-size: 3rem;
            color: #667eea;
            margin-bottom: 15px;
        }

        .upload-area p {
            color: #666;
            margin-bottom: 10px;
        }

        .controls-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .control-group {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .control-group h3 {
            margin-bottom: 15px;
            color: #667eea;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-item {
            margin-bottom: 15px;
        }

        .control-item label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        input[type="range"], input[type="number"], input[type="text"], select {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        .range-value {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .range-value input[type="number"] {
            width: 80px;
        }

        .preview-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .image-container {
            position: relative;
            background: #f8f9fa;
            border-radius: 10px;
            overflow: hidden;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            max-width: 100%;
            max-height: 70vh;
        }

        .image-container img,
        .image-container canvas {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .image-container img {
            max-width: 100%;
            max-height: 400px;
            object-fit: contain;
        }

        .image-placeholder {
            color: #999;
            text-align: center;
            padding: 40px;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        button {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .url-output {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #28a745;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            word-break: break-all;
        }

        .url-output h4 {
            margin-bottom: 10px;
            color: #28a745;
        }

        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            background: #e9ecef;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: #667eea;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            header h1 {
                font-size: 2rem;
            }
        }

        .color-picker {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .color-picker input[type="color"] {
            width: 50px;
            height: 40px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ImageProcess Demo</h1>
            <p>Goå›¾åƒå¤„ç†åº“åŠŸèƒ½æ¼”ç¤º - æ”¯æŒç¼©æ”¾ã€è£å‰ªã€æ°´å°ã€æ ¼å¼è½¬æ¢ç­‰</p>
        </header>

        <div class="main-content">
            <div class="upload-section">
                <div class="upload-area" id="uploadArea">
                    <i>ğŸ“</i>
                    <h3>ä¸Šä¼ å›¾ç‰‡</h3>
                    <p>ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤åŒºåŸŸ</p>
                    <p class="small">æ”¯æŒ JPG, PNG, WEBP, BMP, TIFF, GIF</p>
                    <input type="file" id="fileInput" accept="image/*" style="display: none;">
                </div>
            </div>

            <div class="controls-section">
                <div class="tabs">
                    <button class="tab active" data-tab="resize">ç¼©æ”¾</button>
                    <button class="tab" data-tab="crop">è£å‰ª</button>
                    <button class="tab" data-tab="watermark">æ°´å°</button>
                    <button class="tab" data-tab="adjust">è°ƒæ•´</button>
                    <button class="tab" data-tab="format">æ ¼å¼</button>
                </div>

                <div class="tab-content active" id="resize-tab">
                    <div class="control-group">
                        <h3>ğŸ”„ å›¾ç‰‡ç¼©æ”¾</h3>
                        <div class="control-item">
                            <label>ç¼©æ”¾æ¨¡å¼</label>
                            <select id="resizeMode">
                                <option value="lfit">ç­‰æ¯”ç¼©æ”¾ (lfit)</option>
                                <option value="mfit">å»¶ä¼¸ç¼©æ”¾ (mfit)</option>
                                <option value="fill">å¡«å……è£å‰ª (fill)</option>
                                <option value="pad">ç¼©æ”¾å¡«å…… (pad)</option>
                                <option value="fixed">å›ºå®šå®½é«˜ (fixed)</option>
                            </select>
                        </div>
                        <div class="control-item">
                            <label>å®½åº¦ (px)</label>
                            <input type="number" id="resizeWidth" min="1" max="16384" placeholder="å®½åº¦">
                        </div>
                        <div class="control-item">
                            <label>é«˜åº¦ (px)</label>
                            <input type="number" id="resizeHeight" min="1" max="16384" placeholder="é«˜åº¦">
                        </div>
                        <div class="control-item" id="colorSection" style="display: none;">
                            <label>å¡«å……é¢œè‰²</label>
                            <div class="color-picker">
                                <input type="color" id="resizeColor" value="#FFFFFF">
                                <span id="colorHex">#FFFFFF</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="crop-tab">
                    <div class="control-group">
                        <h3>âœ‚ï¸ å›¾ç‰‡è£å‰ª</h3>
                        <div class="control-item">
                            <label>è£å‰ªä½ç½®</label>
                            <select id="cropPosition">
                                <option value="custom">è‡ªå®šä¹‰åæ ‡</option>
                                <option value="nw">å·¦ä¸Š (NorthWest)</option>
                                <option value="north">ä¸Šä¸­ (North)</option>
                                <option value="ne">å³ä¸Š (NorthEast)</option>
                                <option value="west">å·¦ä¸­ (West)</option>
                                <option value="center">ä¸­å¿ƒ (Center)</option>
                                <option value="east">å³ä¸­ (East)</option>
                                <option value="sw">å·¦ä¸‹ (SouthWest)</option>
                                <option value="south">ä¸‹ä¸­ (South)</option>
                                <option value="se">å³ä¸‹ (SouthEast)</option>
                            </select>
                        </div>
                        <div class="control-item">
                            <label>Xåæ ‡ (px)</label>
                            <input type="number" id="cropX" min="0" placeholder="Xåæ ‡">
                        </div>
                        <div class="control-item">
                            <label>Yåæ ‡ (px)</label>
                            <input type="number" id="cropY" min="0" placeholder="Yåæ ‡">
                        </div>
                        <div class="control-item">
                            <label>è£å‰ªå®½åº¦ (px)</label>
                            <input type="number" id="cropWidth" min="1" placeholder="å®½åº¦">
                        </div>
                        <div class="control-item">
                            <label>è£å‰ªé«˜åº¦ (px)</label>
                            <input type="number" id="cropHeight" min="1" placeholder="é«˜åº¦">
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="watermark-tab">
                    <div class="control-group">
                        <h3>ğŸ’§ æ–‡å­—æ°´å°</h3>
                        <div class="control-item">
                            <label>æ°´å°æ–‡å­—</label>
                            <input type="text" id="watermarkText" placeholder="è¾“å…¥æ°´å°æ–‡å­—">
                        </div>
                        <div class="control-item">
                            <label>å­—ä½“å¤§å°</label>
                            <input type="number" id="watermarkSize" min="10" max="200" value="30">
                        </div>
                        <div class="control-item">
                            <label>æ°´å°é¢œè‰²</label>
                            <div class="color-picker">
                                <input type="color" id="watermarkColor" value="#000000">
                                <span id="watermarkColorHex">#000000</span>
                            </div>
                        </div>
                        <div class="control-item">
                            <label>é€æ˜åº¦ (%)</label>
                            <input type="range" id="watermarkOpacity" min="0" max="100" value="80">
                            <span id="opacityValue">80%</span>
                        </div>
                        <div class="control-item">
                            <label>æ°´å°ä½ç½®</label>
                            <select id="watermarkPosition">
                                <option value="nw">å·¦ä¸Š</option>
                                <option value="north">ä¸Šä¸­</option>
                                <option value="ne">å³ä¸Š</option>
                                <option value="west">å·¦ä¸­</option>
                                <option value="center">ä¸­å¿ƒ</option>
                                <option value="east">å³ä¸­</option>
                                <option value="sw">å·¦ä¸‹</option>
                                <option value="south">ä¸‹ä¸­</option>
                                <option value="se">å³ä¸‹</option>
                            </select>
                        </div>
                        <div class="control-item">
                            <label>æ°´å¹³è¾¹è· (px)</label>
                            <input type="number" id="watermarkX" min="0" value="10">
                        </div>
                        <div class="control-item">
                            <label>å‚ç›´è¾¹è· (px)</label>
                            <input type="number" id="watermarkY" min="0" value="10">
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="adjust-tab">
                    <div class="control-group">
                        <h3>ğŸ›ï¸ å›¾åƒè°ƒæ•´</h3>
                        <div class="control-item">
                            <label>äº®åº¦è°ƒæ•´ (-100 åˆ° 100)</label>
                            <input type="range" id="brightness" min="-100" max="100" value="0">
                            <span id="brightnessValue">0</span>
                        </div>
                        <div class="control-item">
                            <label>å¯¹æ¯”åº¦è°ƒæ•´ (-100 åˆ° 100)</label>
                            <input type="range" id="contrast" min="-100" max="100" value="0">
                            <span id="contrastValue">0</span>
                        </div>
                        <div class="control-item">
                            <label>é”åŒ–ç¨‹åº¦ (0 åˆ° 500)</label>
                            <input type="range" id="sharpen" min="0" max="500" value="0">
                            <span id="sharpenValue">0</span>
                        </div>
                        <div class="control-item">
                            <label>æ¨¡ç³Šç¨‹åº¦ (0 åˆ° 100)</label>
                            <input type="range" id="blur" min="0" max="100" value="0">
                            <span id="blurValue">0</span>
                        </div>
                        <div class="control-item">
                            <label>æ—‹è½¬è§’åº¦ (åº¦)</label>
                            <input type="range" id="rotate" min="0" max="360" value="0">
                            <span id="rotateValue">0Â°</span>
                        </div>
                        <div class="control-item">
                            <label>å›¾ç‰‡è´¨é‡ (1-100)</label>
                            <input type="range" id="quality" min="1" max="100" value="90">
                            <span id="qualityValue">90%</span>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="format-tab">
                    <div class="control-group">
                        <h3>ğŸ”„ æ ¼å¼è½¬æ¢</h3>
                        <div class="control-item">
                            <label>è¾“å‡ºæ ¼å¼</label>
                            <select id="outputFormat">
                                <option value="jpg">JPG</option>
                                <option value="jpeg">JPEG</option>
                                <option value="png">PNG</option>
                                <option value="webp">WEBP</option>
                                <option value="bmp">BMP</option>
                                <option value="tiff">TIFF</option>
                                <option value="gif">GIF</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="preview-section">
                <div class="image-container">
                    <div class="image-placeholder" id="imagePlaceholder">
                        <i>ğŸ–¼ï¸</i>
                        <p>è¯·ä¸Šä¼ å›¾ç‰‡å¼€å§‹ç¼–è¾‘</p>
                    </div>
                    <img id="previewImage" style="display: none;">
                    <canvas id="previewCanvas" style="display: none;"></canvas>
                    <div id="imageSizeInfo" style="display: none; position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;"></div>
                </div>

                <div class="action-buttons">
                    <button class="btn-secondary" id="resetAll">é‡ç½®æ‰€æœ‰è®¾ç½®</button>
                </div>

                <div class="url-output" id="urlOutput" style="display: none;">
                    <h4>ç”Ÿæˆçš„å›¾ç‰‡å¤„ç†URL:</h4>
                    <div style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
                        <code id="generatedUrl" style="flex: 1; padding: 8px; background: #f5f5f5; border-radius: 4px;"></code>
                        <button id="copyUrl" class="btn-primary" style="white-space: nowrap; display: none;">å¤åˆ¶URL</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentImage = null;
        let originalImageData = null;
        let previewCanvas = null;
        let previewCtx = null;
        let useCanvasPreview = true;

        // DOMå…ƒç´ 
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const imagePlaceholder = document.getElementById('imagePlaceholder');
        const previewImage = document.getElementById('previewImage');
        const generateUrlBtn = document.getElementById('generateUrl');
        const resetBtn = document.getElementById('resetAll');
        const urlOutput = document.getElementById('urlOutput');
        const generatedUrl = document.getElementById('generatedUrl');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');

        // åˆå§‹åŒ–Canvas
        function initCanvas() {
            previewCanvas = document.getElementById('previewCanvas');
            previewCtx = previewCanvas.getContext('2d');
            
            // æ·»åŠ é¢„è§ˆåˆ‡æ¢æŒ‰é’®
            const previewToggle = document.createElement('button');
            previewToggle.className = 'btn-secondary';
            previewToggle.id = 'togglePreview';
            previewToggle.textContent = 'åˆ‡æ¢Canvasé¢„è§ˆ';
            previewToggle.style.marginTop = '10px';
            previewToggle.style.width = '140px';
            previewToggle.addEventListener('click', toggleCanvasPreview);
            
            document.querySelector('.action-buttons').appendChild(previewToggle);
        }

        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
        function initEvents() {
            // åˆå§‹åŒ–Canvas
            initCanvas();
            
            // ä¸Šä¼ åŒºåŸŸç‚¹å‡»äº‹ä»¶
            uploadArea.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('drop', handleDrop);

            // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
            fileInput.addEventListener('change', handleFileSelect);

            // æ ‡ç­¾åˆ‡æ¢äº‹ä»¶
            tabs.forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });

            // ç¼©æ”¾æ¨¡å¼å˜åŒ–äº‹ä»¶
            document.getElementById('resizeMode').addEventListener('change', updateColorSection);

            // é¢œè‰²é€‰æ‹©å™¨äº‹ä»¶
            document.getElementById('resizeColor').addEventListener('input', updateColorHex);
            document.getElementById('watermarkColor').addEventListener('input', updateWatermarkColorHex);

            // æ»‘å—å€¼æ˜¾ç¤ºäº‹ä»¶
            setupRangeInputs();

            // æŒ‰é’®äº‹ä»¶
            resetBtn.addEventListener('click', resetAllSettings);

            // æ·»åŠ å®æ—¶é¢„è§ˆç›‘å¬å™¨
            setupRealTimePreview();
        }

        // å¤„ç†æ‹–æ‹½äº‹ä»¶
        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.style.borderColor = '#764ba2';
        }

        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.style.borderColor = '#667eea';

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processImageFile(files[0]);
            }
        }

        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                processImageFile(file);
            }
        }

        // å¤„ç†å›¾ç‰‡æ–‡ä»¶
        function processImageFile(file) {
            if (!file.type.startsWith('image/')) {
                alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶ï¼');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                currentImage = new Image();
                currentImage.onload = function() {
                    showPreview(currentImage);
                    originalImageData = e.target.result;
                };
                currentImage.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // æ˜¾ç¤ºé¢„è§ˆ
        function showPreview(image) {
            imagePlaceholder.style.display = 'none';
            
            // æ˜¾ç¤ºå›¾ç‰‡å°ºå¯¸ä¿¡æ¯
            const sizeInfo = document.getElementById('imageSizeInfo');
            sizeInfo.textContent = `${image.width} Ã— ${image.height} px`;
            sizeInfo.style.display = 'block';
            
            if (useCanvasPreview) {
                previewImage.style.display = 'none';
                previewCanvas.style.display = 'block';
                currentImage = image;
                updateCanvasPreview();
            } else {
                previewCanvas.style.display = 'none';
                previewImage.style.display = 'block';
                previewImage.src = image.src;
            }
        }

        // åˆ‡æ¢æ ‡ç­¾
        function switchTab(tabName) {
            tabs.forEach(tab => tab.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));

            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }

        // æ›´æ–°é¢œè‰²é€‰æ‹©å™¨æ˜¾ç¤º
        function updateColorSection() {
            const mode = document.getElementById('resizeMode').value;
            const colorSection = document.getElementById('colorSection');
            colorSection.style.display = mode === 'pad' ? 'block' : 'none';
        }

        function updateColorHex(e) {
            document.getElementById('colorHex').textContent = e.target.value;
        }

        function updateWatermarkColorHex(e) {
            document.getElementById('watermarkColorHex').textContent = e.target.value;
        }

        // è®¾ç½®æ»‘å—è¾“å…¥
        function setupRangeInputs() {
            const rangeInputs = [
                { id: 'watermarkOpacity', output: 'opacityValue', suffix: '%' },
                { id: 'brightness', output: 'brightnessValue' },
                { id: 'contrast', output: 'contrastValue' },
                { id: 'sharpen', output: 'sharpenValue' },
                { id: 'blur', output: 'blurValue' },
                { id: 'rotate', output: 'rotateValue', suffix: 'Â°' },
                { id: 'quality', output: 'qualityValue', suffix: '%' }
            ];

            rangeInputs.forEach(input => {
                const slider = document.getElementById(input.id);
                const output = document.getElementById(input.output);
                
                slider.addEventListener('input', () => {
                    output.textContent = slider.value + (input.suffix || '');
                });
            });
        }

        // ç”Ÿæˆå›¾ç‰‡å¤„ç†URL
        function generateImageUrl() {
            if (!currentImage) {
                alert('è¯·å…ˆä¸Šä¼ å›¾ç‰‡ï¼');
                return;
            }

            const params = [];
            
            // ç¼©æ”¾å‚æ•°
            const resizeWidth = document.getElementById('resizeWidth').value;
            const resizeHeight = document.getElementById('resizeHeight').value;
            const resizeMode = document.getElementById('resizeMode').value;
            
            if (resizeWidth || resizeHeight) {
                let resizeParam = 'resize';
                if (resizeMode !== 'lfit') resizeParam += `,m_${resizeMode}`;
                if (resizeWidth) resizeParam += `,w_${resizeWidth}`;
                if (resizeHeight) resizeParam += `,h_${resizeHeight}`;
                
                if (resizeMode === 'pad') {
                    const color = document.getElementById('resizeColor').value.replace('#', '');
                    resizeParam += `,color_${color}`;
                }
                
                params.push(resizeParam);
            }

            // è£å‰ªå‚æ•°
            const cropWidth = document.getElementById('cropWidth').value;
            const cropHeight = document.getElementById('cropHeight').value;
            if (cropWidth && cropHeight) {
                let cropParam = `crop,w_${cropWidth},h_${cropHeight}`;
                
                const position = document.getElementById('cropPosition').value;
                if (position === 'custom') {
                    const x = document.getElementById('cropX').value;
                    const y = document.getElementById('cropY').value;
                    if (x) cropParam += `,x_${x}`;
                    if (y) cropParam += `,y_${y}`;
                } else {
                    cropParam += `,g_${position}`;
                }
                
                params.push(cropParam);
            }

            // æ°´å°å‚æ•°
            const watermarkText = document.getElementById('watermarkText').value;
            if (watermarkText) {
                let watermarkParam = 'watermark';
                watermarkParam += `,text_${encodeURIComponent(watermarkText)}`;
                watermarkParam += `,size_${document.getElementById('watermarkSize').value}`;
                
                const color = document.getElementById('watermarkColor').value.replace('#', '');
                watermarkParam += `,color_${color}`;
                
                watermarkParam += `,t_${document.getElementById('watermarkOpacity').value}`;
                watermarkParam += `,g_${document.getElementById('watermarkPosition').value}`;
                watermarkParam += `,x_${document.getElementById('watermarkX').value}`;
                watermarkParam += `,y_${document.getElementById('watermarkY').value}`;
                
                params.push(watermarkParam);
            }

            // è°ƒæ•´å‚æ•°
            const brightness = document.getElementById('brightness').value;
            const contrast = document.getElementById('contrast').value;
            const sharpen = document.getElementById('sharpen').value;
            const blur = document.getElementById('blur').value;
            const rotate = document.getElementById('rotate').value;
            const quality = document.getElementById('quality').value;

            if (brightness !== '0') params.push(`bright,${brightness}`);
            if (contrast !== '0') params.push(`contrast,${contrast}`);
            if (sharpen !== '0') params.push(`sharpen,${sharpen}`);
            if (blur !== '0') params.push(`blur,${blur}`);
            if (rotate !== '0') params.push(`rotate,${rotate}`);
            if (quality !== '90') params.push(`quality,q_${quality}`);

            // æ ¼å¼è½¬æ¢
            const outputFormat = document.getElementById('outputFormat').value;
            if (outputFormat !== 'jpg') {
                params.push(`format,${outputFormat}`);
            }

            // ç”Ÿæˆæœ€ç»ˆURL
            if (params.length > 0) {
                const url = `x-oss-process=image/${params.join('/')}`;
                generatedUrl.textContent = url;
                urlOutput.style.display = 'block';
                
                // ä¸ºå¤åˆ¶æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
                const copyButton = document.getElementById('copyUrl');
                copyButton.onclick = function() {
                    navigator.clipboard.writeText(url).then(() => {
                        alert('URLå·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
                    });
                };
                copyButton.style.display = 'inline-block';
            } else {
                alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªå¤„ç†é€‰é¡¹ï¼');
            }
        }

        // é‡ç½®æ‰€æœ‰è®¾ç½®
        function resetAllSettings() {
            // é‡ç½®æ‰€æœ‰è¾“å…¥å­—æ®µ
            document.querySelectorAll('input[type="number"], input[type="text"], input[type="range"]').forEach(input => {
                if (input.type === 'range') {
                    input.value = input.id === 'quality' ? '90' : '0';
                } else if (input.type === 'text') {
                    input.value = '';
                } else {
                    input.value = '';
                }
            });

            // é‡ç½®é€‰æ‹©æ¡†
            document.querySelectorAll('select').forEach(select => {
                if (select.id === 'resizeMode') {
                    select.value = 'lfit';
                } else if (select.id === 'cropPosition') {
                    select.value = 'custom';
                } else if (select.id === 'watermarkPosition') {
                    select.value = 'se';
                } else if (select.id === 'outputFormat') {
                    select.value = 'jpg';
                }
            });

            // é‡ç½®é¢œè‰²é€‰æ‹©å™¨
            document.getElementById('resizeColor').value = '#FFFFFF';
            document.getElementById('watermarkColor').value = '#000000';
            document.getElementById('colorHex').textContent = '#FFFFFF';
            document.getElementById('watermarkColorHex').textContent = '#000000';

            // æ›´æ–°æ»‘å—æ˜¾ç¤º
            setupRangeInputs();

            // éšè—URLè¾“å‡º
            urlOutput.style.display = 'none';

            // é‡æ–°åŠ è½½åŸå§‹å›¾ç‰‡
            if (currentImage) {
                // é‡ç½®Canvaså°ºå¯¸
                previewCanvas.width = currentImage.width;
                previewCanvas.height = currentImage.height;
                previewCtx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
                previewCtx.drawImage(currentImage, 0, 0);
                
                // æ›´æ–°å›¾ç‰‡ä¿¡æ¯æ˜¾ç¤º
                updateImageInfo();
            }

            alert('æ‰€æœ‰è®¾ç½®å·²é‡ç½®ï¼');
        }

        // è®¾ç½®å®æ—¶é¢„è§ˆç›‘å¬å™¨
        function setupRealTimePreview() {
            const inputs = document.querySelectorAll('input[type="range"], input[type="number"], input[type="text"], select, input[type="color"]');
            inputs.forEach(input => {
                input.addEventListener('input', debounce(updateCanvasPreview, 300));
                input.addEventListener('change', debounce(updateCanvasPreview, 300));
            });
        }

        // é˜²æŠ–å‡½æ•°
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // åˆ‡æ¢Canvasé¢„è§ˆ
        function toggleCanvasPreview() {
            useCanvasPreview = !useCanvasPreview;
            const toggleBtn = document.getElementById('togglePreview');
            toggleBtn.textContent = useCanvasPreview ? 'åˆ‡æ¢å›¾ç‰‡é¢„è§ˆ' : 'åˆ‡æ¢Canvasé¢„è§ˆ';
            
            if (currentImage) {
                if (useCanvasPreview) {
                    previewImage.style.display = 'none';
                    previewCanvas.style.display = 'block';
                    updateCanvasPreview();
                } else {
                    previewCanvas.style.display = 'none';
                    previewImage.style.display = 'block';
                    // é‡æ–°è®¾ç½®å›¾ç‰‡srcä»¥ç¡®ä¿æ˜¾ç¤ºåŸå›¾
                    previewImage.src = currentImage.src;
                }
            }
        }

        // æ›´æ–°Canvasé¢„è§ˆ
        function updateCanvasPreview() {
            if (!currentImage || !useCanvasPreview) return;

            // è·å–ç¼©æ”¾å‚æ•°
            const resizeWidth = parseInt(document.getElementById('resizeWidth').value) || currentImage.width;
            const resizeHeight = parseInt(document.getElementById('resizeHeight').value) || currentImage.height;
            const resizeMode = document.getElementById('resizeMode').value;

            // è®¾ç½®Canvaså°ºå¯¸ï¼ˆä½¿ç”¨ç¼©æ”¾åçš„å°ºå¯¸ï¼‰
            previewCanvas.width = resizeWidth;
            previewCanvas.height = resizeHeight;

            // æ¸…é™¤Canvas
            previewCtx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);

            // åº”ç”¨ç¼©æ”¾å¹¶ç»˜åˆ¶å›¾ç‰‡
            applyResizeEffect();

            // åº”ç”¨å›¾åƒè°ƒæ•´æ•ˆæœ
            applyImageAdjustments();

            // åº”ç”¨æ°´å°æ•ˆæœ
            applyWatermark();

            // åº”ç”¨è£å‰ªé¢„è§ˆï¼ˆä»…æ˜¾ç¤ºè£å‰ªåŒºåŸŸï¼‰
            showCropPreview();
            
            // è‡ªåŠ¨ç”ŸæˆURL
            generateImageUrl();
        }

        // åº”ç”¨å›¾åƒè°ƒæ•´æ•ˆæœ
        function applyResizeEffect() {
            const resizeWidth = parseInt(document.getElementById('resizeWidth').value) || currentImage.width;
            const resizeHeight = parseInt(document.getElementById('resizeHeight').value) || currentImage.height;
            const resizeMode = document.getElementById('resizeMode').value;

            // æ ¹æ®ç¼©æ”¾æ¨¡å¼å¤„ç†
            if (resizeMode === 'fit') {
                // ä¿æŒå®½é«˜æ¯”é€‚åº”
                const scale = Math.min(resizeWidth / currentImage.width, resizeHeight / currentImage.height);
                const width = currentImage.width * scale;
                const height = currentImage.height * scale;
                const x = (resizeWidth - width) / 2;
                const y = (resizeHeight - height) / 2;
                previewCtx.drawImage(currentImage, x, y, width, height);
            } else if (resizeMode === 'fill') {
                // å¡«å……å¹¶è£å‰ª
                const scale = Math.max(resizeWidth / currentImage.width, resizeHeight / currentImage.height);
                const width = currentImage.width * scale;
                const height = currentImage.height * scale;
                const x = (resizeWidth - width) / 2;
                const y = (resizeHeight - height) / 2;
                previewCtx.drawImage(currentImage, x, y, width, height);
            } else {
                // æ‹‰ä¼¸æ¨¡å¼
                previewCtx.drawImage(currentImage, 0, 0, resizeWidth, resizeHeight);
            }
        }

        function applyImageAdjustments() {
            const brightness = parseInt(document.getElementById('brightness').value);
            const contrast = parseInt(document.getElementById('contrast').value);
            const blur = parseInt(document.getElementById('blur').value);
            const rotate = parseInt(document.getElementById('rotate').value);

            if (brightness !== 0 || contrast !== 0 || blur !== 0 || rotate !== 0) {
                // åˆ›å»ºä¸´æ—¶Canvasç”¨äºå¤„ç†æ•ˆæœ
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                tempCanvas.width = previewCanvas.width;
                tempCanvas.height = previewCanvas.height;
                
                // å¤åˆ¶å½“å‰Canvaså†…å®¹
                tempCtx.drawImage(previewCanvas, 0, 0);

                // åº”ç”¨æ»¤é•œæ•ˆæœ
                let filter = '';
                if (brightness !== 0) filter += `brightness(${1 + brightness / 100}) `;
                if (contrast !== 0) filter += `contrast(${1 + contrast / 100}) `;
                if (blur !== 0) filter += `blur(${blur}px) `;
                
                previewCtx.filter = filter;
                previewCtx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
                
                // åº”ç”¨æ—‹è½¬
                if (rotate !== 0) {
                    previewCtx.save();
                    previewCtx.translate(previewCanvas.width / 2, previewCanvas.height / 2);
                    previewCtx.rotate(rotate * Math.PI / 180);
                    previewCtx.drawImage(tempCanvas, -previewCanvas.width / 2, -previewCanvas.height / 2);
                    previewCtx.restore();
                } else {
                    previewCtx.drawImage(tempCanvas, 0, 0);
                }
                
                previewCtx.filter = 'none';
            }
        }

        // åº”ç”¨æ°´å°æ•ˆæœ
        function applyWatermark() {
            const watermarkText = document.getElementById('watermarkText').value;
            if (!watermarkText) return;

            const size = parseInt(document.getElementById('watermarkSize').value);
            const color = document.getElementById('watermarkColor').value;
            const opacity = parseInt(document.getElementById('watermarkOpacity').value) / 100;
            const position = document.getElementById('watermarkPosition').value;
            const x = parseInt(document.getElementById('watermarkX').value);
            const y = parseInt(document.getElementById('watermarkY').value);

            previewCtx.save();
            previewCtx.globalAlpha = opacity;
            previewCtx.font = `${size}px Arial`;
            previewCtx.fillStyle = color;
            previewCtx.textAlign = 'center';
            previewCtx.textBaseline = 'middle';

            let posX, posY;
            switch (position) {
                case 'nw': posX = x + size; posY = y + size; break;
                case 'north': posX = previewCanvas.width / 2; posY = y + size; break;
                case 'ne': posX = previewCanvas.width - x - size; posY = y + size; break;
                case 'west': posX = x + size; posY = previewCanvas.height / 2; break;
                case 'center': posX = previewCanvas.width / 2; posY = previewCanvas.height / 2; break;
                case 'east': posX = previewCanvas.width - x - size; posY = previewCanvas.height / 2; break;
                case 'sw': posX = x + size; posY = previewCanvas.height - y - size; break;
                case 'south': posX = previewCanvas.width / 2; posY = previewCanvas.height - y - size; break;
                case 'se': posX = previewCanvas.width - x - size; posY = previewCanvas.height - y - size; break;
            }

            previewCtx.fillText(watermarkText, posX, posY);
            previewCtx.restore();
        }

        // æ˜¾ç¤ºè£å‰ªé¢„è§ˆ
        function showCropPreview() {
            const cropWidth = document.getElementById('cropWidth').value;
            const cropHeight = document.getElementById('cropHeight').value;
            if (!cropWidth || !cropHeight) return;

            const width = parseInt(cropWidth);
            const height = parseInt(cropHeight);
            let x = 0, y = 0;

            const position = document.getElementById('cropPosition').value;
            if (position === 'custom') {
                x = parseInt(document.getElementById('cropX').value) || 0;
                y = parseInt(document.getElementById('cropY').value) || 0;
            } else {
                // æ ¹æ®ä½ç½®è®¡ç®—åæ ‡
                switch (position) {
                    case 'nw': x = 0; y = 0; break;
                    case 'north': x = (previewCanvas.width - width) / 2; y = 0; break;
                    case 'ne': x = previewCanvas.width - width; y = 0; break;
                    case 'west': x = 0; y = (previewCanvas.height - height) / 2; break;
                    case 'center': x = (previewCanvas.width - width) / 2; y = (previewCanvas.height - height) / 2; break;
                    case 'east': x = previewCanvas.width - width; y = (previewCanvas.height - height) / 2; break;
                    case 'sw': x = 0; y = previewCanvas.height - height; break;
                    case 'south': x = (previewCanvas.width - width) / 2; y = previewCanvas.height - height; break;
                    case 'se': x = previewCanvas.width - width; y = previewCanvas.height - height; break;
                }
            }

            // ç»˜åˆ¶è£å‰ªåŒºåŸŸè¾¹æ¡†
            previewCtx.save();
            previewCtx.strokeStyle = '#ff6b6b';
            previewCtx.lineWidth = 2;
            previewCtx.setLineDash([5, 5]);
            previewCtx.strokeRect(x, y, width, height);
            
            // ç»˜åˆ¶åŠé€æ˜é®ç½©
            previewCtx.fillStyle = 'rgba(0, 0, 0, 0.3)';
            previewCtx.fillRect(0, 0, previewCanvas.width, y); // ä¸Š
            previewCtx.fillRect(0, y + height, previewCanvas.width, previewCanvas.height - y - height); // ä¸‹
            previewCtx.fillRect(0, y, x, height); // å·¦
            previewCtx.fillRect(x + width, y, previewCanvas.width - x - width, height); // å³
            
            previewCtx.restore();
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initEvents);
    </script>
</body>
</html>
