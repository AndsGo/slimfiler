<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ImageProcess Demo - Go图像处理库演示</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .upload-section {
            grid-column: 1 / -1;
            text-align: center;
            margin-bottom: 20px;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            background: #f8f9ff;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: #eef2ff;
        }

        .upload-area i {
            font-size: 3rem;
            color: #667eea;
            margin-bottom: 15px;
        }

        .upload-area p {
            color: #666;
            margin-bottom: 10px;
        }

        .controls-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .control-group {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .control-group h3 {
            margin-bottom: 15px;
            color: #667eea;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-item {
            margin-bottom: 15px;
        }

        .control-item label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        input[type="range"], input[type="number"], input[type="text"], select {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        .range-value {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .range-value input[type="number"] {
            width: 80px;
        }

        .preview-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .image-container {
            position: relative;
            background: #f8f9fa;
            border-radius: 10px;
            overflow: hidden;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            max-width: 100%;
            max-height: 70vh;
        }

        .image-container img,
        .image-container canvas {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .image-container img {
            max-width: 100%;
            max-height: 400px;
            object-fit: contain;
        }

        .image-placeholder {
            color: #999;
            text-align: center;
            padding: 40px;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        button {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .url-output {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #28a745;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            word-break: break-all;
        }

        .url-output h4 {
            margin-bottom: 10px;
            color: #28a745;
        }

        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            background: #e9ecef;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: #667eea;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            header h1 {
                font-size: 2rem;
            }
        }

        .color-picker {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .color-picker input[type="color"] {
            width: 50px;
            height: 40px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ImageProcess Demo</h1>
            <p>Go图像处理库功能演示 - 支持缩放、裁剪、水印、格式转换等</p>
        </header>

        <div class="main-content">
            <div class="upload-section">
                <div class="upload-area" id="uploadArea">
                    <i>📁</i>
                    <h3>上传图片</h3>
                    <p>点击或拖拽图片到此区域</p>
                    <p class="small">支持 JPG, PNG, WEBP, BMP, TIFF, GIF</p>
                    <input type="file" id="fileInput" accept="image/*" style="display: none;">
                </div>
            </div>

            <div class="controls-section">
                <div class="tabs">
                    <button class="tab active" data-tab="resize">缩放</button>
                    <button class="tab" data-tab="crop">裁剪</button>
                    <button class="tab" data-tab="watermark">水印</button>
                    <button class="tab" data-tab="adjust">调整</button>
                    <button class="tab" data-tab="format">格式</button>
                </div>

                <div class="tab-content active" id="resize-tab">
                    <div class="control-group">
                        <h3>🔄 图片缩放</h3>
                        <div class="control-item">
                            <label>缩放模式</label>
                            <select id="resizeMode">
                                <option value="lfit">等比缩放 (lfit)</option>
                                <option value="mfit">延伸缩放 (mfit)</option>
                                <option value="fill">填充裁剪 (fill)</option>
                                <option value="pad">缩放填充 (pad)</option>
                                <option value="fixed">固定宽高 (fixed)</option>
                            </select>
                        </div>
                        <div class="control-item">
                            <label>宽度 (px)</label>
                            <input type="number" id="resizeWidth" min="1" max="16384" placeholder="宽度">
                        </div>
                        <div class="control-item">
                            <label>高度 (px)</label>
                            <input type="number" id="resizeHeight" min="1" max="16384" placeholder="高度">
                        </div>
                        <div class="control-item" id="colorSection" style="display: none;">
                            <label>填充颜色</label>
                            <div class="color-picker">
                                <input type="color" id="resizeColor" value="#FFFFFF">
                                <span id="colorHex">#FFFFFF</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="crop-tab">
                    <div class="control-group">
                        <h3>✂️ 图片裁剪</h3>
                        <div class="control-item">
                            <label>裁剪位置</label>
                            <select id="cropPosition">
                                <option value="custom">自定义坐标</option>
                                <option value="nw">左上 (NorthWest)</option>
                                <option value="north">上中 (North)</option>
                                <option value="ne">右上 (NorthEast)</option>
                                <option value="west">左中 (West)</option>
                                <option value="center">中心 (Center)</option>
                                <option value="east">右中 (East)</option>
                                <option value="sw">左下 (SouthWest)</option>
                                <option value="south">下中 (South)</option>
                                <option value="se">右下 (SouthEast)</option>
                            </select>
                        </div>
                        <div class="control-item">
                            <label>X坐标 (px)</label>
                            <input type="number" id="cropX" min="0" placeholder="X坐标">
                        </div>
                        <div class="control-item">
                            <label>Y坐标 (px)</label>
                            <input type="number" id="cropY" min="0" placeholder="Y坐标">
                        </div>
                        <div class="control-item">
                            <label>裁剪宽度 (px)</label>
                            <input type="number" id="cropWidth" min="1" placeholder="宽度">
                        </div>
                        <div class="control-item">
                            <label>裁剪高度 (px)</label>
                            <input type="number" id="cropHeight" min="1" placeholder="高度">
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="watermark-tab">
                    <div class="control-group">
                        <h3>💧 文字水印</h3>
                        <div class="control-item">
                            <label>水印文字</label>
                            <input type="text" id="watermarkText" placeholder="输入水印文字">
                        </div>
                        <div class="control-item">
                            <label>字体大小</label>
                            <input type="number" id="watermarkSize" min="10" max="200" value="30">
                        </div>
                        <div class="control-item">
                            <label>水印颜色</label>
                            <div class="color-picker">
                                <input type="color" id="watermarkColor" value="#000000">
                                <span id="watermarkColorHex">#000000</span>
                            </div>
                        </div>
                        <div class="control-item">
                            <label>透明度 (%)</label>
                            <input type="range" id="watermarkOpacity" min="0" max="100" value="80">
                            <span id="opacityValue">80%</span>
                        </div>
                        <div class="control-item">
                            <label>水印位置</label>
                            <select id="watermarkPosition">
                                <option value="nw">左上</option>
                                <option value="north">上中</option>
                                <option value="ne">右上</option>
                                <option value="west">左中</option>
                                <option value="center">中心</option>
                                <option value="east">右中</option>
                                <option value="sw">左下</option>
                                <option value="south">下中</option>
                                <option value="se">右下</option>
                            </select>
                        </div>
                        <div class="control-item">
                            <label>水平边距 (px)</label>
                            <input type="number" id="watermarkX" min="0" value="10">
                        </div>
                        <div class="control-item">
                            <label>垂直边距 (px)</label>
                            <input type="number" id="watermarkY" min="0" value="10">
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="adjust-tab">
                    <div class="control-group">
                        <h3>🎛️ 图像调整</h3>
                        <div class="control-item">
                            <label>亮度调整 (-100 到 100)</label>
                            <input type="range" id="brightness" min="-100" max="100" value="0">
                            <span id="brightnessValue">0</span>
                        </div>
                        <div class="control-item">
                            <label>对比度调整 (-100 到 100)</label>
                            <input type="range" id="contrast" min="-100" max="100" value="0">
                            <span id="contrastValue">0</span>
                        </div>
                        <div class="control-item">
                            <label>锐化程度 (0 到 500)</label>
                            <input type="range" id="sharpen" min="0" max="500" value="0">
                            <span id="sharpenValue">0</span>
                        </div>
                        <div class="control-item">
                            <label>模糊程度 (0 到 100)</label>
                            <input type="range" id="blur" min="0" max="100" value="0">
                            <span id="blurValue">0</span>
                        </div>
                        <div class="control-item">
                            <label>旋转角度 (度)</label>
                            <input type="range" id="rotate" min="0" max="360" value="0">
                            <span id="rotateValue">0°</span>
                        </div>
                        <div class="control-item">
                            <label>图片质量 (1-100)</label>
                            <input type="range" id="quality" min="1" max="100" value="90">
                            <span id="qualityValue">90%</span>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="format-tab">
                    <div class="control-group">
                        <h3>🔄 格式转换</h3>
                        <div class="control-item">
                            <label>输出格式</label>
                            <select id="outputFormat">
                                <option value="jpg">JPG</option>
                                <option value="jpeg">JPEG</option>
                                <option value="png">PNG</option>
                                <option value="webp">WEBP</option>
                                <option value="bmp">BMP</option>
                                <option value="tiff">TIFF</option>
                                <option value="gif">GIF</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="preview-section">
                <div class="image-container">
                    <div class="image-placeholder" id="imagePlaceholder">
                        <i>🖼️</i>
                        <p>请上传图片开始编辑</p>
                    </div>
                    <img id="previewImage" style="display: none;">
                    <canvas id="previewCanvas" style="display: none;"></canvas>
                    <div id="imageSizeInfo" style="display: none; position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;"></div>
                </div>

                <div class="action-buttons">
                    <button class="btn-secondary" id="resetAll">重置所有设置</button>
                </div>

                <div class="url-output" id="urlOutput" style="display: none;">
                    <h4>生成的图片处理URL:</h4>
                    <div style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
                        <code id="generatedUrl" style="flex: 1; padding: 8px; background: #f5f5f5; border-radius: 4px;"></code>
                        <button id="copyUrl" class="btn-primary" style="white-space: nowrap; display: none;">复制URL</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let currentImage = null;
        let originalImageData = null;
        let previewCanvas = null;
        let previewCtx = null;
        let useCanvasPreview = true;

        // DOM元素
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const imagePlaceholder = document.getElementById('imagePlaceholder');
        const previewImage = document.getElementById('previewImage');
        const generateUrlBtn = document.getElementById('generateUrl');
        const resetBtn = document.getElementById('resetAll');
        const urlOutput = document.getElementById('urlOutput');
        const generatedUrl = document.getElementById('generatedUrl');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');

        // 初始化Canvas
        function initCanvas() {
            previewCanvas = document.getElementById('previewCanvas');
            previewCtx = previewCanvas.getContext('2d');
            
            // 添加预览切换按钮
            const previewToggle = document.createElement('button');
            previewToggle.className = 'btn-secondary';
            previewToggle.id = 'togglePreview';
            previewToggle.textContent = '切换Canvas预览';
            previewToggle.style.marginTop = '10px';
            previewToggle.style.width = '140px';
            previewToggle.addEventListener('click', toggleCanvasPreview);
            
            document.querySelector('.action-buttons').appendChild(previewToggle);
        }

        // 初始化事件监听
        function initEvents() {
            // 初始化Canvas
            initCanvas();
            
            // 上传区域点击事件
            uploadArea.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('drop', handleDrop);

            // 文件选择事件
            fileInput.addEventListener('change', handleFileSelect);

            // 标签切换事件
            tabs.forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });

            // 缩放模式变化事件
            document.getElementById('resizeMode').addEventListener('change', updateColorSection);

            // 颜色选择器事件
            document.getElementById('resizeColor').addEventListener('input', updateColorHex);
            document.getElementById('watermarkColor').addEventListener('input', updateWatermarkColorHex);

            // 滑块值显示事件
            setupRangeInputs();

            // 按钮事件
            resetBtn.addEventListener('click', resetAllSettings);

            // 添加实时预览监听器
            setupRealTimePreview();
        }

        // 处理拖拽事件
        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.style.borderColor = '#764ba2';
        }

        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.style.borderColor = '#667eea';

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processImageFile(files[0]);
            }
        }

        // 处理文件选择
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                processImageFile(file);
            }
        }

        // 处理图片文件
        function processImageFile(file) {
            if (!file.type.startsWith('image/')) {
                alert('请选择图片文件！');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                currentImage = new Image();
                currentImage.onload = function() {
                    showPreview(currentImage);
                    originalImageData = e.target.result;
                };
                currentImage.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // 显示预览
        function showPreview(image) {
            imagePlaceholder.style.display = 'none';
            
            // 显示图片尺寸信息
            const sizeInfo = document.getElementById('imageSizeInfo');
            sizeInfo.textContent = `${image.width} × ${image.height} px`;
            sizeInfo.style.display = 'block';
            
            if (useCanvasPreview) {
                previewImage.style.display = 'none';
                previewCanvas.style.display = 'block';
                currentImage = image;
                updateCanvasPreview();
            } else {
                previewCanvas.style.display = 'none';
                previewImage.style.display = 'block';
                previewImage.src = image.src;
            }
        }

        // 切换标签
        function switchTab(tabName) {
            tabs.forEach(tab => tab.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));

            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }

        // 更新颜色选择器显示
        function updateColorSection() {
            const mode = document.getElementById('resizeMode').value;
            const colorSection = document.getElementById('colorSection');
            colorSection.style.display = mode === 'pad' ? 'block' : 'none';
        }

        function updateColorHex(e) {
            document.getElementById('colorHex').textContent = e.target.value;
        }

        function updateWatermarkColorHex(e) {
            document.getElementById('watermarkColorHex').textContent = e.target.value;
        }

        // 设置滑块输入
        function setupRangeInputs() {
            const rangeInputs = [
                { id: 'watermarkOpacity', output: 'opacityValue', suffix: '%' },
                { id: 'brightness', output: 'brightnessValue' },
                { id: 'contrast', output: 'contrastValue' },
                { id: 'sharpen', output: 'sharpenValue' },
                { id: 'blur', output: 'blurValue' },
                { id: 'rotate', output: 'rotateValue', suffix: '°' },
                { id: 'quality', output: 'qualityValue', suffix: '%' }
            ];

            rangeInputs.forEach(input => {
                const slider = document.getElementById(input.id);
                const output = document.getElementById(input.output);
                
                slider.addEventListener('input', () => {
                    output.textContent = slider.value + (input.suffix || '');
                });
            });
        }

        // 生成图片处理URL
        function generateImageUrl() {
            if (!currentImage) {
                alert('请先上传图片！');
                return;
            }

            const params = [];
            
            // 缩放参数
            const resizeWidth = document.getElementById('resizeWidth').value;
            const resizeHeight = document.getElementById('resizeHeight').value;
            const resizeMode = document.getElementById('resizeMode').value;
            
            if (resizeWidth || resizeHeight) {
                let resizeParam = 'resize';
                if (resizeMode !== 'lfit') resizeParam += `,m_${resizeMode}`;
                if (resizeWidth) resizeParam += `,w_${resizeWidth}`;
                if (resizeHeight) resizeParam += `,h_${resizeHeight}`;
                
                if (resizeMode === 'pad') {
                    const color = document.getElementById('resizeColor').value.replace('#', '');
                    resizeParam += `,color_${color}`;
                }
                
                params.push(resizeParam);
            }

            // 裁剪参数
            const cropWidth = document.getElementById('cropWidth').value;
            const cropHeight = document.getElementById('cropHeight').value;
            if (cropWidth && cropHeight) {
                let cropParam = `crop,w_${cropWidth},h_${cropHeight}`;
                
                const position = document.getElementById('cropPosition').value;
                if (position === 'custom') {
                    const x = document.getElementById('cropX').value;
                    const y = document.getElementById('cropY').value;
                    if (x) cropParam += `,x_${x}`;
                    if (y) cropParam += `,y_${y}`;
                } else {
                    cropParam += `,g_${position}`;
                }
                
                params.push(cropParam);
            }

            // 水印参数
            const watermarkText = document.getElementById('watermarkText').value;
            if (watermarkText) {
                let watermarkParam = 'watermark';
                watermarkParam += `,text_${encodeURIComponent(watermarkText)}`;
                watermarkParam += `,size_${document.getElementById('watermarkSize').value}`;
                
                const color = document.getElementById('watermarkColor').value.replace('#', '');
                watermarkParam += `,color_${color}`;
                
                watermarkParam += `,t_${document.getElementById('watermarkOpacity').value}`;
                watermarkParam += `,g_${document.getElementById('watermarkPosition').value}`;
                watermarkParam += `,x_${document.getElementById('watermarkX').value}`;
                watermarkParam += `,y_${document.getElementById('watermarkY').value}`;
                
                params.push(watermarkParam);
            }

            // 调整参数
            const brightness = document.getElementById('brightness').value;
            const contrast = document.getElementById('contrast').value;
            const sharpen = document.getElementById('sharpen').value;
            const blur = document.getElementById('blur').value;
            const rotate = document.getElementById('rotate').value;
            const quality = document.getElementById('quality').value;

            if (brightness !== '0') params.push(`bright,${brightness}`);
            if (contrast !== '0') params.push(`contrast,${contrast}`);
            if (sharpen !== '0') params.push(`sharpen,${sharpen}`);
            if (blur !== '0') params.push(`blur,${blur}`);
            if (rotate !== '0') params.push(`rotate,${rotate}`);
            if (quality !== '90') params.push(`quality,q_${quality}`);

            // 格式转换
            const outputFormat = document.getElementById('outputFormat').value;
            if (outputFormat !== 'jpg') {
                params.push(`format,${outputFormat}`);
            }

            // 生成最终URL
            if (params.length > 0) {
                const url = `x-oss-process=image/${params.join('/')}`;
                generatedUrl.textContent = url;
                urlOutput.style.display = 'block';
                
                // 为复制按钮添加点击事件
                const copyButton = document.getElementById('copyUrl');
                copyButton.onclick = function() {
                    navigator.clipboard.writeText(url).then(() => {
                        alert('URL已复制到剪贴板！');
                    });
                };
                copyButton.style.display = 'inline-block';
            } else {
                alert('请至少选择一个处理选项！');
            }
        }

        // 重置所有设置
        function resetAllSettings() {
            // 重置所有输入字段
            document.querySelectorAll('input[type="number"], input[type="text"], input[type="range"]').forEach(input => {
                if (input.type === 'range') {
                    input.value = input.id === 'quality' ? '90' : '0';
                } else if (input.type === 'text') {
                    input.value = '';
                } else {
                    input.value = '';
                }
            });

            // 重置选择框
            document.querySelectorAll('select').forEach(select => {
                if (select.id === 'resizeMode') {
                    select.value = 'lfit';
                } else if (select.id === 'cropPosition') {
                    select.value = 'custom';
                } else if (select.id === 'watermarkPosition') {
                    select.value = 'se';
                } else if (select.id === 'outputFormat') {
                    select.value = 'jpg';
                }
            });

            // 重置颜色选择器
            document.getElementById('resizeColor').value = '#FFFFFF';
            document.getElementById('watermarkColor').value = '#000000';
            document.getElementById('colorHex').textContent = '#FFFFFF';
            document.getElementById('watermarkColorHex').textContent = '#000000';

            // 更新滑块显示
            setupRangeInputs();

            // 隐藏URL输出
            urlOutput.style.display = 'none';

            // 重新加载原始图片
            if (currentImage) {
                // 重置Canvas尺寸
                previewCanvas.width = currentImage.width;
                previewCanvas.height = currentImage.height;
                previewCtx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
                previewCtx.drawImage(currentImage, 0, 0);
                
                // 更新图片信息显示
                updateImageInfo();
            }

            alert('所有设置已重置！');
        }

        // 设置实时预览监听器
        function setupRealTimePreview() {
            const inputs = document.querySelectorAll('input[type="range"], input[type="number"], input[type="text"], select, input[type="color"]');
            inputs.forEach(input => {
                input.addEventListener('input', debounce(updateCanvasPreview, 300));
                input.addEventListener('change', debounce(updateCanvasPreview, 300));
            });
        }

        // 防抖函数
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // 切换Canvas预览
        function toggleCanvasPreview() {
            useCanvasPreview = !useCanvasPreview;
            const toggleBtn = document.getElementById('togglePreview');
            toggleBtn.textContent = useCanvasPreview ? '切换图片预览' : '切换Canvas预览';
            
            if (currentImage) {
                if (useCanvasPreview) {
                    previewImage.style.display = 'none';
                    previewCanvas.style.display = 'block';
                    updateCanvasPreview();
                } else {
                    previewCanvas.style.display = 'none';
                    previewImage.style.display = 'block';
                    // 重新设置图片src以确保显示原图
                    previewImage.src = currentImage.src;
                }
            }
        }

        // 更新Canvas预览
        function updateCanvasPreview() {
            if (!currentImage || !useCanvasPreview) return;

            // 获取缩放参数
            const resizeWidth = parseInt(document.getElementById('resizeWidth').value) || currentImage.width;
            const resizeHeight = parseInt(document.getElementById('resizeHeight').value) || currentImage.height;
            const resizeMode = document.getElementById('resizeMode').value;

            // 设置Canvas尺寸（使用缩放后的尺寸）
            previewCanvas.width = resizeWidth;
            previewCanvas.height = resizeHeight;

            // 清除Canvas
            previewCtx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);

            // 应用缩放并绘制图片
            applyResizeEffect();

            // 应用图像调整效果
            applyImageAdjustments();

            // 应用水印效果
            applyWatermark();

            // 应用裁剪预览（仅显示裁剪区域）
            showCropPreview();
            
            // 自动生成URL
            generateImageUrl();
        }

        // 应用图像调整效果
        function applyResizeEffect() {
            const resizeWidth = parseInt(document.getElementById('resizeWidth').value) || currentImage.width;
            const resizeHeight = parseInt(document.getElementById('resizeHeight').value) || currentImage.height;
            const resizeMode = document.getElementById('resizeMode').value;

            // 根据缩放模式处理
            if (resizeMode === 'fit') {
                // 保持宽高比适应
                const scale = Math.min(resizeWidth / currentImage.width, resizeHeight / currentImage.height);
                const width = currentImage.width * scale;
                const height = currentImage.height * scale;
                const x = (resizeWidth - width) / 2;
                const y = (resizeHeight - height) / 2;
                previewCtx.drawImage(currentImage, x, y, width, height);
            } else if (resizeMode === 'fill') {
                // 填充并裁剪
                const scale = Math.max(resizeWidth / currentImage.width, resizeHeight / currentImage.height);
                const width = currentImage.width * scale;
                const height = currentImage.height * scale;
                const x = (resizeWidth - width) / 2;
                const y = (resizeHeight - height) / 2;
                previewCtx.drawImage(currentImage, x, y, width, height);
            } else {
                // 拉伸模式
                previewCtx.drawImage(currentImage, 0, 0, resizeWidth, resizeHeight);
            }
        }

        function applyImageAdjustments() {
            const brightness = parseInt(document.getElementById('brightness').value);
            const contrast = parseInt(document.getElementById('contrast').value);
            const blur = parseInt(document.getElementById('blur').value);
            const rotate = parseInt(document.getElementById('rotate').value);

            if (brightness !== 0 || contrast !== 0 || blur !== 0 || rotate !== 0) {
                // 创建临时Canvas用于处理效果
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                tempCanvas.width = previewCanvas.width;
                tempCanvas.height = previewCanvas.height;
                
                // 复制当前Canvas内容
                tempCtx.drawImage(previewCanvas, 0, 0);

                // 应用滤镜效果
                let filter = '';
                if (brightness !== 0) filter += `brightness(${1 + brightness / 100}) `;
                if (contrast !== 0) filter += `contrast(${1 + contrast / 100}) `;
                if (blur !== 0) filter += `blur(${blur}px) `;
                
                previewCtx.filter = filter;
                previewCtx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
                
                // 应用旋转
                if (rotate !== 0) {
                    previewCtx.save();
                    previewCtx.translate(previewCanvas.width / 2, previewCanvas.height / 2);
                    previewCtx.rotate(rotate * Math.PI / 180);
                    previewCtx.drawImage(tempCanvas, -previewCanvas.width / 2, -previewCanvas.height / 2);
                    previewCtx.restore();
                } else {
                    previewCtx.drawImage(tempCanvas, 0, 0);
                }
                
                previewCtx.filter = 'none';
            }
        }

        // 应用水印效果
        function applyWatermark() {
            const watermarkText = document.getElementById('watermarkText').value;
            if (!watermarkText) return;

            const size = parseInt(document.getElementById('watermarkSize').value);
            const color = document.getElementById('watermarkColor').value;
            const opacity = parseInt(document.getElementById('watermarkOpacity').value) / 100;
            const position = document.getElementById('watermarkPosition').value;
            const x = parseInt(document.getElementById('watermarkX').value);
            const y = parseInt(document.getElementById('watermarkY').value);

            previewCtx.save();
            previewCtx.globalAlpha = opacity;
            previewCtx.font = `${size}px Arial`;
            previewCtx.fillStyle = color;
            previewCtx.textAlign = 'center';
            previewCtx.textBaseline = 'middle';

            let posX, posY;
            switch (position) {
                case 'nw': posX = x + size; posY = y + size; break;
                case 'north': posX = previewCanvas.width / 2; posY = y + size; break;
                case 'ne': posX = previewCanvas.width - x - size; posY = y + size; break;
                case 'west': posX = x + size; posY = previewCanvas.height / 2; break;
                case 'center': posX = previewCanvas.width / 2; posY = previewCanvas.height / 2; break;
                case 'east': posX = previewCanvas.width - x - size; posY = previewCanvas.height / 2; break;
                case 'sw': posX = x + size; posY = previewCanvas.height - y - size; break;
                case 'south': posX = previewCanvas.width / 2; posY = previewCanvas.height - y - size; break;
                case 'se': posX = previewCanvas.width - x - size; posY = previewCanvas.height - y - size; break;
            }

            previewCtx.fillText(watermarkText, posX, posY);
            previewCtx.restore();
        }

        // 显示裁剪预览
        function showCropPreview() {
            const cropWidth = document.getElementById('cropWidth').value;
            const cropHeight = document.getElementById('cropHeight').value;
            if (!cropWidth || !cropHeight) return;

            const width = parseInt(cropWidth);
            const height = parseInt(cropHeight);
            let x = 0, y = 0;

            const position = document.getElementById('cropPosition').value;
            if (position === 'custom') {
                x = parseInt(document.getElementById('cropX').value) || 0;
                y = parseInt(document.getElementById('cropY').value) || 0;
            } else {
                // 根据位置计算坐标
                switch (position) {
                    case 'nw': x = 0; y = 0; break;
                    case 'north': x = (previewCanvas.width - width) / 2; y = 0; break;
                    case 'ne': x = previewCanvas.width - width; y = 0; break;
                    case 'west': x = 0; y = (previewCanvas.height - height) / 2; break;
                    case 'center': x = (previewCanvas.width - width) / 2; y = (previewCanvas.height - height) / 2; break;
                    case 'east': x = previewCanvas.width - width; y = (previewCanvas.height - height) / 2; break;
                    case 'sw': x = 0; y = previewCanvas.height - height; break;
                    case 'south': x = (previewCanvas.width - width) / 2; y = previewCanvas.height - height; break;
                    case 'se': x = previewCanvas.width - width; y = previewCanvas.height - height; break;
                }
            }

            // 绘制裁剪区域边框
            previewCtx.save();
            previewCtx.strokeStyle = '#ff6b6b';
            previewCtx.lineWidth = 2;
            previewCtx.setLineDash([5, 5]);
            previewCtx.strokeRect(x, y, width, height);
            
            // 绘制半透明遮罩
            previewCtx.fillStyle = 'rgba(0, 0, 0, 0.3)';
            previewCtx.fillRect(0, 0, previewCanvas.width, y); // 上
            previewCtx.fillRect(0, y + height, previewCanvas.width, previewCanvas.height - y - height); // 下
            previewCtx.fillRect(0, y, x, height); // 左
            previewCtx.fillRect(x + width, y, previewCanvas.width - x - width, height); // 右
            
            previewCtx.restore();
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', initEvents);
    </script>
</body>
</html>
